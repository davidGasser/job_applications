{% extends "base.html" %}

{% block title %}Job Listings - {{ super() }}{% endblock %}

{% block head %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .threshold-control {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 1.5rem;
    }

    .threshold-label {
        font-weight: 600;
        color: var(--text-color);
        white-space: nowrap;
    }

    .threshold-slider-container {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 1rem;
        max-width: 400px;
    }

    .threshold-slider {
        flex: 1;
        height: 6px;
        border-radius: 3px;
        background: linear-gradient(to right, #fee2e2 0%, #fef3c7 50%, #d1fae5 100%);
        outline: none;
        -webkit-appearance: none;
    }

    .threshold-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .threshold-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .threshold-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary-color);
        min-width: 50px;
        text-align: center;
    }

    /* Scrape Selector Carousel */
    .scrape-selector-section {
        margin-bottom: 2rem;
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: var(--shadow-sm);
    }

    .scrape-selector-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .scrape-selector-header h3 {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .confirm-scrape-button {
        background-color: var(--success-color);
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    .confirm-scrape-button:hover {
        background-color: #059669;
    }

    .confirm-scrape-button:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
        opacity: 0.5;
    }

    .confirm-scrape-button:disabled:hover {
        background-color: #9ca3af;
        transform: none;
        box-shadow: none;
    }

    /* Custom Confirmation Modal */
    .confirm-modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }

    .confirm-modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 2rem;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: var(--shadow-lg);
    }

    .confirm-modal-header {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--text-color);
    }

    .confirm-modal-body {
        margin-bottom: 1.5rem;
        color: var(--text-secondary);
        line-height: 1.6;
    }

    .confirm-modal-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        padding: 0.75rem;
        background-color: var(--background-color);
        border-radius: 8px;
    }

    .confirm-modal-checkbox input[type="checkbox"] {
        width: auto;
        cursor: pointer;
    }

    .confirm-modal-checkbox label {
        cursor: pointer;
        font-size: 0.9rem;
        margin: 0;
    }

    .confirm-modal-actions {
        display: flex;
        gap: 0.75rem;
    }

    .confirm-modal-actions button {
        flex: 1;
    }

    .scrape-carousel {
        display: flex;
        gap: 1rem;
        overflow-x: auto;
        padding: 0.5rem 0;
        scroll-behavior: smooth;
    }

    .scrape-carousel::-webkit-scrollbar {
        height: 6px;
    }

    .scrape-carousel::-webkit-scrollbar-track {
        background: var(--background-color);
        border-radius: 3px;
    }

    .scrape-carousel::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 3px;
    }

    .scrape-chip {
        flex-shrink: 0;
        padding: 1rem 1.25rem;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        background-color: white;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        min-width: 280px;
        max-width: 320px;
    }

    .scrape-chip:hover {
        border-color: var(--primary-color);
        background-color: var(--primary-light);
    }

    .scrape-chip.active {
        border-color: var(--primary-color);
        background-color: var(--primary-color);
        color: white;
    }

    .scrape-chip.processed {
        border-color: var(--success-color);
        background-color: #d1fae5;
    }

    .scrape-chip.processed.active {
        border-color: var(--success-color);
        background-color: var(--success-color);
    }

    .scrape-chip-title {
        font-weight: 600;
        font-size: 0.95rem;
    }

    .scrape-chip-location {
        font-size: 0.8rem;
        opacity: 0.85;
    }

    .scrape-chip-filters {
        font-size: 0.75rem;
        opacity: 0.8;
        line-height: 1.4;
    }

    .scrape-chip-meta {
        font-size: 0.7rem;
        opacity: 0.75;
        padding-top: 0.25rem;
        border-top: 1px solid currentColor;
        display: flex;
        justify-content: space-between;
    }

    .processed-badge {
        display: inline-block;
        background-color: var(--success-color);
        color: white;
        padding: 0.15rem 0.5rem;
        border-radius: 10px;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .job-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.25rem;
        margin-bottom: 1.5rem;
    }

    /* Job Card with Score */
    .job-card {
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.65rem;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s;
        cursor: pointer;
        position: relative;
    }

    .job-card:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary-color);
        transform: translateY(-2px);
    }

    .job-card.shortlisted {
        border-color: #ef4444;
        background-color: #fef2f2;
    }

    .job-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .job-card-title {
        flex: 1;
        min-width: 0;
    }

    .job-card h3 {
        margin: 0 0 0.4rem 0;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-color);
        line-height: 1.3;
    }

    .job-card .company {
        margin: 0;
        font-size: 0.95rem;
        color: var(--text-secondary);
        font-weight: 600;
    }

    .job-card .location {
        margin: 0.4rem 0 0 0;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .job-card-badges {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .shortlist-heart {
        font-size: 1.4rem;
        color: var(--border-color);
        transition: all 0.2s;
        line-height: 1;
    }

    .shortlist-heart.shortlisted {
        color: #ef4444;
    }

    .matching-score {
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        text-align: center;
        min-width: 50px;
        position: relative;
        cursor: help;
    }

    .score-tooltip {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 0.5rem;
        background-color: white;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 0.75rem;
        box-shadow: var(--shadow-lg);
        z-index: 100;
        min-width: 280px;
        font-size: 0.75rem;
        font-weight: 400;
    }

    .matching-score:hover .score-tooltip {
        display: block;
    }

    .score-tooltip-header {
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: var(--text-color);
        font-size: 0.8rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem;
    }

    .score-breakdown {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.4rem;
        margin-bottom: 0.5rem;
    }

    .score-breakdown-item {
        display: contents;
    }

    .score-breakdown-label {
        color: var(--text-secondary);
    }

    .score-breakdown-value {
        font-weight: 600;
        text-align: right;
        color: var(--text-color);
    }

    .score-tooltip-summary {
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid var(--border-color);
        color: var(--text-secondary);
        line-height: 1.4;
    }

    .score-high {
        background-color: #d1fae5;
        color: #065f46;
    }

    .score-medium {
        background-color: #fef3c7;
        color: #92400e;
    }

    .score-low {
        background-color: #fee2e2;
        color: #991b1b;
    }

    .job-meta {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        padding-top: 0.65rem;
        border-top: 1px solid var(--border-color);
        font-size: 0.75rem;
        color: var(--text-secondary);
        flex-grow: 1;
    }

    .shortlist-button {
        width: 100%;
        margin-top: auto;
        padding: 0.75rem;
        font-size: 0.95rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        background-color: var(--primary-color);
        border: none;
        transition: all 0.2s;
        border-radius: 8px;
        color: white;
    }

    .shortlist-button:hover {
        background-color: var(--primary-hover);
    }

    .shortlist-button.shortlisted {
        background-color: #ef4444;
    }

    .shortlist-button.shortlisted:hover {
        background-color: #dc2626;
    }

    .expand-low-scores {
        grid-column: 1 / -1;
        text-align: center;
        padding: 1.5rem;
        background-color: var(--card-background);
        border: 2px dashed var(--border-color);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .expand-low-scores:hover {
        border-color: var(--primary-color);
        background-color: var(--primary-light);
    }

    .expand-low-scores span {
        color: var(--text-secondary);
        font-weight: 500;
    }

    .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
    }

    .empty-state h3 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
        color: var(--text-color);
    }

    /* Modal */
    #job-details-modal .modal-content {
        width: 80%;
        max-width: none;
        height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 4px solid var(--border-color);
        transition: border-color 0.3s ease;
    }

    #job-details-modal .modal-body-wrapper {
        overflow-y: auto;
        flex: 1;
        padding: 0 2rem;
    }

    #job-details-modal .modal-content.shortlisted-border {
        border-color: #10b981;
    }

    .nav-job-button {
        background: none;
        border: 2px solid var(--border-color);
        color: var(--text-color);
        font-size: 2rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        padding: 0;
        line-height: 1;
    }

    .nav-job-button:hover:not(:disabled) {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        transform: scale(1.1);
    }

    .nav-job-button:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .modal-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0 1.5rem 0.35rem 1.5rem;
        margin-top: 0 !important;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        flex-shrink: 0;
    }

    .modal-header-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        margin-bottom: 0 !important;
    }

    .modal-header-content * {
        margin-bottom: 0 !important;
    }

    .modal-header h2 {
        margin: 0 !important;
        font-size: 1.5rem;
        line-height: 1.3;
    }

    #job-details-modal .modal-header {
        padding-bottom: 0 !important;
        margin-bottom: 0 !important;
    }

    #job-details-modal .modal-header * {
        margin-bottom: 0 !important;
    }

    .modal-subheader {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        font-size: 0.95rem;
        color: var(--text-secondary);
    }

    .modal-subheader-item {
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .modal-subheader-divider {
        color: var(--border-color);
    }

    .modal-actions {
        padding: 1rem 1.5rem 0 1.5rem;
        margin-bottom: 0 !important;
        flex-shrink: 0;
    }

    .job-description-box {
        background-color: var(--background-color);
        padding: 1.5rem;
        border-radius: 8px;
        font-size: 0.9rem;
        line-height: 1.7;
        color: var(--text-color);
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .info-section {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background-color: var(--background-color);
        border-radius: 8px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .info-item-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .info-item-value {
        font-size: 0.95rem;
        color: var(--text-color);
    }

    .info-item-value a {
        color: var(--primary-color);
        text-decoration: underline;
    }

    .modal-section {
        margin-bottom: 1.5rem;
    }

    .modal-section h3 {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 0 0 1rem 0;
        color: var(--text-color);
    }

    .score-details-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .score-detail-card {
        background-color: var(--background-color);
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        text-align: center;
    }

    .score-detail-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 600;
    }

    .score-detail-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--primary-color);
    }

    .score-reasoning {
        background-color: var(--background-color);
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid var(--primary-color);
    }

    .score-reasoning h4 {
        font-size: 0.9rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
        color: var(--text-color);
    }

    .score-reasoning ul {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
    }

    .score-reasoning li {
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .score-reasoning-strengths {
        color: #065f46;
    }

    .score-reasoning-concerns {
        color: #991b1b;
    }

    .score-reasoning-summary {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--border-color);
        font-size: 0.95rem;
        color: var(--text-secondary);
        line-height: 1.6;
    }

    .modal-nav-bar {
        padding: 0.5rem 1.5rem;
        margin: 1.2rem 0;
        background-color: var(--background-color);
        border-bottom: 1px solid var(--border-color);
        font-size: 0.75rem;
        color: var(--text-secondary);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .modal-nav-shortcuts {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
    }

    .modal-nav-shortcut {
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .modal-nav-key {
        background-color: white;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 0.15rem 0.4rem;
        font-family: monospace;
        font-size: 0.75rem;
        font-weight: 600;
    }

    #job-details-modal .modal-actions {
        display: flex;
        gap: 0.75rem;
        border-top: 1px solid var(--border-color);
    }

    .modal-actions button, .modal-actions a {
        flex: 1;
        margin-bottom: 0 !important;
    }

    .no-scrapes-message {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }
</style>
{% endblock %}

{% block content %}
    <div class="page-header">
        <h1>All Job Listings</h1>
        <a href="{{ url_for('scrape.scrape') }}" class="btn">+ Scrape New Jobs</a>
    </div>

    {% if scrapes %}
    <div class="threshold-control">
        <span class="threshold-label">Score Threshold:</span>
        <div class="threshold-slider-container">
            <input type="range" id="threshold-slider" class="threshold-slider" min="0" max="100" value="80" step="5">
            <span class="threshold-value" id="threshold-value">80%</span>
        </div>
    </div>
    <div class="scrape-selector-section">
        <div class="scrape-selector-header">
            <h3>Select Scrape to Review</h3>
            <button id="confirm-scrape-button" class="btn confirm-scrape-button" style="display: none;">
                ‚úì Confirm & Clean Up Scrape
            </button>
        </div>
        <div class="scrape-carousel" id="scrape-carousel">
            {% for scrape in scrapes %}
            <div class="scrape-chip {% if loop.first %}active{% endif %} {% if scrape.is_processed %}processed{% endif %}"
                 data-scrape-id="{{ scrape.id }}"
                 data-is-processed="{{ 'true' if scrape.is_processed else 'false' }}"
                 data-non-shortlisted="{{ scrape.non_shortlisted_count }}">
                <div class="scrape-chip-title">
                    {{ scrape.keywords }}
                    {% if scrape.is_processed %}<span class="processed-badge">‚úì Processed</span>{% endif %}
                </div>
                <div class="scrape-chip-location">üìç {{ scrape.locations }}</div>
                {% if scrape.distance_in_km or scrape.date_posted or scrape.exp_level or scrape.job_type %}
                <div class="scrape-chip-filters">
                    {% set filters = [] %}
                    {% if scrape.distance_in_km %}{% set _ = filters.append(scrape.distance_in_km ~ 'km') %}{% endif %}
                    {% if scrape.date_posted %}{% set _ = filters.append(scrape.date_posted) %}{% endif %}
                    {% if scrape.exp_level %}{% set _ = filters.append(scrape.exp_level) %}{% endif %}
                    {% if scrape.job_type %}{% set _ = filters.append(scrape.job_type) %}{% endif %}
                    {{ filters | join(' ‚Ä¢ ') }}
                </div>
                {% endif %}
                <div class="scrape-chip-meta">
                    <span>{{ scrape.created_at.strftime('%b %d, %Y %H:%M') }}</span>
                    <span>{{ scrape.job_count }} jobs</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="jobs-container" class="job-grid">
        <!-- Jobs will be loaded here dynamically -->
    </div>

    <div id="expand-low-scores-section" style="display: none;">
        <div class="job-grid">
            <div class="expand-low-scores" id="expand-low-scores-button">
                <span id="low-score-count">0 jobs below 80% match - Click to view</span>
            </div>
        </div>
        <div id="low-score-jobs" class="job-grid" style="display: none; margin-top: 1.5rem;">
            <!-- Low scoring jobs will be loaded here -->
        </div>
    </div>

    {% else %}
    <div class="no-scrapes-message">
        <h3>No scrapes yet</h3>
        <p>Start by scraping jobs from LinkedIn</p>
        <a href="{{ url_for('scrape.scrape') }}" class="btn">Go to Scraper</a>
    </div>
    {% endif %}

    <!-- Job Details Modal -->
    <div id="job-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <button id="prev-job-button" class="nav-job-button" type="button">‚Äπ</button>
                <div class="modal-header-content">
                    <h2 id="modal-job-title"></h2>
                    <div class="modal-subheader">
                        <span class="modal-subheader-item">
                            <strong id="modal-job-company"></strong>
                        </span>
                        <span class="modal-subheader-divider">‚Ä¢</span>
                        <span class="modal-subheader-item" id="modal-job-location"></span>
                        <span class="modal-subheader-divider">‚Ä¢</span>
                        <span class="modal-subheader-item">
                            <span id="modal-job-score"></span> match
                        </span>
                    </div>
                    <div class="modal-subheader" style="font-size: 0.85rem; margin-top: 0.15rem; margin-bottom: 0;">
                        <span class="modal-subheader-item">
                            Scraped: <span id="modal-job-scraped"></span>
                        </span>
                        <span class="modal-subheader-divider">‚Ä¢</span>
                        <span class="modal-subheader-item">
                            Last updated: <span id="modal-job-updated"></span>
                        </span>
                    </div>
                </div>
                <button id="next-job-button" class="nav-job-button" type="button">‚Ä∫</button>
                <button class="close-button" type="button">&times;</button>
            </div>

            <div class="modal-nav-bar">
                <div class="modal-nav-shortcuts">
                    <div class="modal-nav-shortcut">
                        <span class="modal-nav-key">‚Üê</span>
                        <span class="modal-nav-key">‚Üí</span>
                        <span>Navigate jobs</span>
                    </div>
                    <div class="modal-nav-shortcut">
                        <span class="modal-nav-key">‚Üë</span>
                        <span class="modal-nav-key">‚Üì</span>
                        <span>Scroll</span>
                    </div>
                    <div class="modal-nav-shortcut">
                        <span class="modal-nav-key">Space</span>
                        <span>Apply</span>
                    </div>
                    <div class="modal-nav-shortcut">
                        <span class="modal-nav-key">Enter</span>
                        <span>Shortlist</span>
                    </div>
                    <div class="modal-nav-shortcut">
                        <span class="modal-nav-key">Esc</span>
                        <span>Close</span>
                    </div>
                </div>
                <div>
                    <span id="modal-job-position">Job 1 of 10</span>
                </div>
            </div>

            <div class="modal-body-wrapper">
                <div class="modal-section" id="score-details-section">
                    <h3>Match Analysis</h3>
                    <div class="score-details-grid" id="modal-score-grid"></div>
                    <div class="score-reasoning" id="modal-score-reasoning"></div>
                </div>

                <div class="modal-section">
                    <h3>Job Description</h3>
                    <div class="job-description-box" id="modal-job-description"></div>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn-secondary" id="close-modal-button">Close</button>
                <button type="button" id="modal-shortlist-button" class="btn">
                    <span id="modal-shortlist-text">‚ô° Shortlist This Job</span>
                </button>
                <a href="#" id="modal-apply-button" class="btn" target="_blank">Apply Now ‚Üí</a>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="confirm-modal">
        <div class="confirm-modal-content">
            <div class="confirm-modal-header">Confirm Scrape Cleanup</div>
            <div class="confirm-modal-body">
                <p id="confirm-message"></p>
            </div>
            <div class="confirm-modal-checkbox">
                <input type="checkbox" id="dont-ask-again">
                <label for="dont-ask-again">Don't ask me again</label>
            </div>
            <div class="confirm-modal-actions">
                <button type="button" class="btn-secondary" id="cancel-confirm">Cancel</button>
                <button type="button" class="btn-danger" id="proceed-confirm">Delete Non-Shortlisted Jobs</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('job-details-modal');
    let currentJobId = null;
    let currentScrapeId = null;
    let allJobs = [];
    let lowScoreJobsExpanded = false;

    let SCORE_THRESHOLD = 80; // Dynamic threshold (adjustable via slider)

    // Threshold slider event listener
    const thresholdSlider = document.getElementById('threshold-slider');
    const thresholdValue = document.getElementById('threshold-value');

    if (thresholdSlider && thresholdValue) {
        thresholdSlider.addEventListener('input', (e) => {
            SCORE_THRESHOLD = parseInt(e.target.value);
            thresholdValue.textContent = SCORE_THRESHOLD + '%';
            renderJobs(); // Re-render with new threshold
        });
    }

    // Load jobs for selected scrape
    function loadScrapeJobs(scrapeId) {
        currentScrapeId = scrapeId;

        fetch(`/scrape/${scrapeId}/jobs`)
            .then(response => response.json())
            .then(jobs => {
                allJobs = jobs;
                renderJobs();

                // Show/hide confirm button based on processed status
                const activeChip = document.querySelector('.scrape-chip.active');
                const confirmButton = document.getElementById('confirm-scrape-button');

                if (activeChip && activeChip.dataset.isProcessed === 'true') {
                    confirmButton.disabled = true;
                    confirmButton.style.display = 'none';
                } else {
                    confirmButton.disabled = false;
                    confirmButton.style.display = 'block';
                }
            });
    }

    // Render jobs (high scores and low scores separately, unless it's archived)
    function renderJobs() {
        const isArchived = currentScrapeId === 'archived';

        if (isArchived) {
            // For archived jobs, show all jobs without any threshold
            const container = document.getElementById('jobs-container');
            container.innerHTML = allJobs.length > 0 ? '' : '<div class="empty-state"><h3>No archived jobs</h3></div>';

            allJobs.forEach(job => {
                container.appendChild(createJobCard(job));
            });

            // Hide low score section for archived
            document.getElementById('expand-low-scores-section').style.display = 'none';
        } else {
            // For regular scrapes, use the threshold
            const highScoreJobs = allJobs.filter(job => job.matching_score >= SCORE_THRESHOLD);
            const lowScoreJobs = allJobs.filter(job => job.matching_score < SCORE_THRESHOLD);

            // Render high score jobs
            const container = document.getElementById('jobs-container');
            container.innerHTML = highScoreJobs.length > 0 ? '' : `<div class="empty-state"><h3>No high-scoring jobs (‚â•${SCORE_THRESHOLD}%)</h3></div>`;

            highScoreJobs.forEach(job => {
                container.appendChild(createJobCard(job));
            });

            // Handle low score jobs section
            const expandSection = document.getElementById('expand-low-scores-section');
            const lowScoreCount = document.getElementById('low-score-count');
            const lowScoreContainer = document.getElementById('low-score-jobs');

            if (lowScoreJobs.length > 0) {
                expandSection.style.display = 'block';
                lowScoreCount.textContent = `${lowScoreJobs.length} jobs below ${SCORE_THRESHOLD}% match - Click to view`;

                if (lowScoreJobsExpanded) {
                    lowScoreContainer.innerHTML = '';
                    lowScoreJobs.forEach(job => {
                        lowScoreContainer.appendChild(createJobCard(job));
                    });
                }
            } else {
                expandSection.style.display = 'none';
            }
        }
    }

    // Create job card element
    function createJobCard(job) {
        const card = document.createElement('div');
        card.className = `job-card ${job.shortlisted ? 'shortlisted' : ''}`;
        card.dataset.jobId = job.id;
        card.dataset.shortlisted = job.shortlisted;

        const scoreClass = job.matching_score >= 90 ? 'score-high' :
                          job.matching_score >= 80 ? 'score-medium' : 'score-low';

        // Parse score details
        let scoreTooltip = '';
        if (job.score_details) {
            try {
                const details = JSON.parse(job.score_details);
                scoreTooltip = `
                    <div class="score-tooltip">
                        <div class="score-tooltip-header">Score Breakdown</div>
                        <div class="score-breakdown">
                            <div class="score-breakdown-item">
                                <span class="score-breakdown-label">Skillset:</span>
                                <span class="score-breakdown-value">${details.skillset}%</span>
                            </div>
                            <div class="score-breakdown-item">
                                <span class="score-breakdown-label">Academic:</span>
                                <span class="score-breakdown-value">${details.academic}%</span>
                            </div>
                            <div class="score-breakdown-item">
                                <span class="score-breakdown-label">Experience:</span>
                                <span class="score-breakdown-value">${details.experience}%</span>
                            </div>
                            <div class="score-breakdown-item">
                                <span class="score-breakdown-label">Professional:</span>
                                <span class="score-breakdown-value">${details.professional}%</span>
                            </div>
                            <div class="score-breakdown-item">
                                <span class="score-breakdown-label">Language:</span>
                                <span class="score-breakdown-value">${details.language}%</span>
                            </div>
                            <div class="score-breakdown-item">
                                <span class="score-breakdown-label">Preference:</span>
                                <span class="score-breakdown-value">${details.preference}%</span>
                            </div>
                        </div>
                        ${details.reasoning && details.reasoning.summary ? `
                            <div class="score-tooltip-summary">${details.reasoning.summary}</div>
                        ` : ''}
                    </div>
                `;
            } catch (e) {
                console.error('Error parsing score details:', e);
            }
        }

        card.innerHTML = `
            <div class="job-card-header">
                <div class="job-card-title">
                    <h3>${job.title}</h3>
                    <p class="company">${job.company}</p>
                </div>
                <div class="job-card-badges">
                    <span class="shortlist-heart ${job.shortlisted ? 'shortlisted' : ''}">
                        ${job.shortlisted ? '‚ô•' : '‚ô°'}
                    </span>
                    <span class="matching-score ${scoreClass}">
                        ${job.matching_score}%
                        ${scoreTooltip}
                    </span>
                </div>
            </div>
            <p class="location">${job.location}</p>
            <div class="job-meta">
                <div><strong>Search:</strong> ${job.search_criteria.keywords} in ${job.search_criteria.locations}</div>
                <div><strong>Scraped:</strong> ${new Date(job.scraped_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}</div>
            </div>
            <button class="shortlist-button ${job.shortlisted ? 'shortlisted' : ''} ${!job.search_criteria_id && job.shortlisted ? 'delete-job-btn' : ''}" data-job-id="${job.id}" data-is-archived="${!job.search_criteria_id}">
                ${!job.search_criteria_id && job.shortlisted ? 'üóë Delete Job' : (job.shortlisted ? '‚ô• Shortlisted' : '‚ô° Shortlist This Job')}
            </button>
        `;

        return card;
    }

    // Scrape chip selection
    document.getElementById('scrape-carousel').addEventListener('click', (e) => {
        const chip = e.target.closest('.scrape-chip');
        if (chip) {
            document.querySelectorAll('.scrape-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            loadScrapeJobs(chip.dataset.scrapeId);
            lowScoreJobsExpanded = false;
            document.getElementById('low-score-jobs').style.display = 'none';
        }
    });

    // Expand low score jobs
    document.getElementById('expand-low-scores-button').addEventListener('click', () => {
        const lowScoreContainer = document.getElementById('low-score-jobs');
        lowScoreJobsExpanded = !lowScoreJobsExpanded;

        if (lowScoreJobsExpanded) {
            lowScoreContainer.style.display = 'grid';
            renderJobs();
            document.getElementById('low-score-count').textContent = 'Click to hide';
        } else {
            lowScoreContainer.style.display = 'none';
            document.getElementById('low-score-count').textContent = `${allJobs.filter(j => j.matching_score < SCORE_THRESHOLD).length} jobs below ${SCORE_THRESHOLD}% match - Click to view`;
        }
    });

    // Custom confirmation modal
    const confirmModal = document.getElementById('confirm-modal');
    const confirmMessage = document.getElementById('confirm-message');
    const dontAskAgainCheckbox = document.getElementById('dont-ask-again');
    const cancelConfirmButton = document.getElementById('cancel-confirm');
    const proceedConfirmButton = document.getElementById('proceed-confirm');

    // Check if user has disabled confirmation
    const skipConfirmation = localStorage.getItem('skipScrapeConfirmation') === 'true';

    cancelConfirmButton.addEventListener('click', () => {
        confirmModal.style.display = 'none';
    });

    proceedConfirmButton.addEventListener('click', () => {
        if (dontAskAgainCheckbox.checked) {
            localStorage.setItem('skipScrapeConfirmation', 'true');
        }
        confirmModal.style.display = 'none';
        performScrapeCleanup(currentScrapeId);
    });

    // Confirm scrape
    document.getElementById('confirm-scrape-button').addEventListener('click', () => {
        if (!currentScrapeId) return;

        const activeChip = document.querySelector('.scrape-chip.active');
        if (activeChip && activeChip.dataset.isProcessed === 'true') {
            return; // Already processed, button should be disabled
        }

        const nonShortlisted = allJobs.filter(j => !j.shortlisted).length;

        if (skipConfirmation) {
            performScrapeCleanup(currentScrapeId);
        } else {
            confirmMessage.textContent = `This will permanently delete ${nonShortlisted} non-shortlisted job${nonShortlisted !== 1 ? 's' : ''} from this scrape. The shortlisted jobs will be kept in your archive.`;
            confirmModal.style.display = 'block';
        }
    });

    function performScrapeCleanup(scrapeId) {
        const nonShortlisted = allJobs.filter(j => !j.shortlisted).length;

        fetch(`/scrape/${scrapeId}/confirm`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                // Show success message in a styled notification
                const statusDiv = document.createElement('div');
                statusDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; animation: slideIn 0.3s ease-out;';
                statusDiv.innerHTML = `<strong>‚úì Cleanup Complete</strong><br>Deleted ${result.deleted_count} jobs. ${result.archived_count} shortlisted job${result.archived_count !== 1 ? 's' : ''} moved to archived.`;
                document.body.appendChild(statusDiv);

                setTimeout(() => {
                    statusDiv.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => statusDiv.remove(), 300);
                }, 3000);

                // Remove the scraper chip from the carousel
                const activeChip = document.querySelector('.scrape-chip.active');
                if (activeChip) {
                    activeChip.remove();
                }

                // Select the first remaining chip or show empty state
                const firstChip = document.querySelector('.scrape-chip');
                if (firstChip) {
                    firstChip.classList.add('active');
                    loadScrapeJobs(firstChip.dataset.scrapeId);
                } else {
                    // No more scrapes, reload page to show empty state
                    location.reload();
                }
            } else {
                alert('Error confirming scrape');
            }
        });
    }

    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === confirmModal) {
            confirmModal.style.display = 'none';
        }
    });

    // Shortlist button handler
    document.addEventListener('click', (e) => {
        const button = e.target.closest('.shortlist-button');
        if (button) {
            e.stopPropagation();
            const jobId = button.dataset.jobId;
            const isArchived = button.dataset.isArchived === 'true';

            // If it's an archived job with delete button, delete it
            if (isArchived && button.classList.contains('delete-job-btn')) {
                if (confirm('Are you sure you want to delete this job?')) {
                    deleteJob(jobId);
                }
            } else {
                // Otherwise, toggle shortlist
                toggleShortlist(jobId);
            }
        }
    });

    // Delete job function
    function deleteJob(jobId) {
        fetch(`/job/${jobId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                // Remove job from allJobs array
                allJobs = allJobs.filter(j => j.id != jobId);
                renderJobs();

                // Close modal if it was open for this job
                if (currentJobId == jobId) {
                    modal.style.display = 'none';
                }
            } else {
                alert('Error deleting job');
            }
        });
    }

    // Toggle shortlist function
    function toggleShortlist(jobId) {
        fetch(`/job/${jobId}/shortlist`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                // Update job in allJobs array
                const job = allJobs.find(j => j.id == jobId);
                if (job) {
                    job.shortlisted = result.shortlisted;
                    renderJobs();
                }

                // Update modal if open
                const modalButton = document.getElementById('modal-shortlist-button');
                const modalText = document.getElementById('modal-shortlist-text');
                const modalContent = modal.querySelector('.modal-content');

                if (modalButton && modalText && currentJobId == jobId) {
                    modalText.textContent = result.shortlisted ? '‚ô• Shortlisted' : '‚ô° Shortlist This Job';
                    modalButton.dataset.action = 'shortlist';
                    if (result.shortlisted) {
                        modalButton.classList.remove('btn');
                        modalButton.classList.add('btn-danger');
                        modalContent.classList.add('shortlisted-border');
                    } else {
                        modalButton.classList.remove('btn-danger');
                        modalButton.classList.add('btn');
                        modalContent.classList.remove('shortlisted-border');
                    }
                }
            }
        });
    }

    // Keyboard navigation for modal
    document.addEventListener('keydown', (e) => {
        // Only handle keyboard shortcuts when modal is open
        if (modal.style.display !== 'block') return;

        // Don't interfere with typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                if (currentJobIndex > 0) {
                    navigateJob(-1);
                }
                break;
            case 'ArrowRight':
                e.preventDefault();
                if (currentJobIndex < currentVisibleJobs.length - 1) {
                    navigateJob(1);
                }
                break;
            case 'ArrowUp':
                e.preventDefault();
                // Scroll up in modal
                const modalBodyUp = modal.querySelector('.modal-body-wrapper');
                modalBodyUp.scrollBy({ top: -100, behavior: 'smooth' });
                break;
            case 'ArrowDown':
                e.preventDefault();
                // Scroll down in modal
                const modalBodyDown = modal.querySelector('.modal-body-wrapper');
                modalBodyDown.scrollBy({ top: 100, behavior: 'smooth' });
                break;
            case ' ':
                e.preventDefault();
                // Click the apply button
                document.getElementById('modal-apply-button').click();
                break;
            case 'Enter':
                e.preventDefault();
                if (currentJobId) {
                    toggleShortlist(currentJobId);
                }
                break;
            case 'Escape':
                e.preventDefault();
                modal.style.display = 'none';
                break;
        }
    });

    // Track current index in visible jobs
    let currentVisibleJobs = [];
    let currentJobIndex = -1;

    // Get currently visible jobs (high score or all if expanded)
    function getVisibleJobs() {
        const isArchived = currentScrapeId === 'archived';
        const lowScoreExpanded = document.getElementById('low-score-jobs').style.display !== 'none';

        if (isArchived || lowScoreExpanded) {
            return allJobs; // All jobs visible
        } else {
            return allJobs.filter(job => job.matching_score >= SCORE_THRESHOLD);
        }
    }

    // Double-click to open modal
    document.addEventListener('dblclick', (e) => {
        if (e.target.closest('.shortlist-button')) return;

        const card = e.target.closest('.job-card');
        if (card) {
            const jobId = card.dataset.jobId;
            currentVisibleJobs = getVisibleJobs();
            currentJobIndex = currentVisibleJobs.findIndex(j => j.id == jobId);
            if (currentJobIndex !== -1) {
                currentJobId = jobId;
                loadJobDetails(currentVisibleJobs[currentJobIndex]);
            }
        }
    });

    // Navigate to previous/next job
    function navigateJob(direction) {
        if (currentVisibleJobs.length === 0) return;

        currentJobIndex += direction;
        if (currentJobIndex < 0) currentJobIndex = 0;
        if (currentJobIndex >= currentVisibleJobs.length) currentJobIndex = currentVisibleJobs.length - 1;

        const job = currentVisibleJobs[currentJobIndex];
        currentJobId = job.id;
        loadJobDetails(job);
    }

    // Load job details into modal
    function loadJobDetails(job) {
        document.getElementById('modal-job-title').textContent = job.title;
        document.getElementById('modal-job-company').textContent = job.company || 'N/A';
        document.getElementById('modal-job-location').textContent = job.location || 'N/A';
        document.getElementById('modal-job-score').textContent = `${job.matching_score}%`;
        document.getElementById('modal-apply-button').href = job.application_link;
        document.getElementById('modal-job-description').textContent = job.description || 'No description available';

        // Format and display timestamps
        const scrapedDate = new Date(job.scraped_at);
        const updatedDate = new Date(job.updated_at);
        document.getElementById('modal-job-scraped').textContent = scrapedDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'});
        document.getElementById('modal-job-updated').textContent = updatedDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'});

        // Parse and display score details
        const scoreDetailsSection = document.getElementById('score-details-section');
        const scoreGrid = document.getElementById('modal-score-grid');
        const scoreReasoning = document.getElementById('modal-score-reasoning');

        if (job.score_details) {
            try {
                const details = JSON.parse(job.score_details);

                // Populate score grid
                scoreGrid.innerHTML = `
                    <div class="score-detail-card">
                        <div class="score-detail-label">Skillset</div>
                        <div class="score-detail-value">${details.skillset}%</div>
                    </div>
                    <div class="score-detail-card">
                        <div class="score-detail-label">Academic</div>
                        <div class="score-detail-value">${details.academic}%</div>
                    </div>
                    <div class="score-detail-card">
                        <div class="score-detail-label">Experience</div>
                        <div class="score-detail-value">${details.experience}%</div>
                    </div>
                    <div class="score-detail-card">
                        <div class="score-detail-label">Professional</div>
                        <div class="score-detail-value">${details.professional}%</div>
                    </div>
                    <div class="score-detail-card">
                        <div class="score-detail-label">Language</div>
                        <div class="score-detail-value">${details.language}%</div>
                    </div>
                    <div class="score-detail-card">
                        <div class="score-detail-label">Preference</div>
                        <div class="score-detail-value">${details.preference}%</div>
                    </div>
                `;

                // Populate reasoning
                let reasoningHTML = '';
                if (details.reasoning) {
                    if (details.reasoning.strengths && details.reasoning.strengths.length > 0) {
                        reasoningHTML += '<h4 class="score-reasoning-strengths">‚úì Strengths</h4><ul class="score-reasoning-strengths">';
                        details.reasoning.strengths.forEach(strength => {
                            reasoningHTML += `<li>${strength}</li>`;
                        });
                        reasoningHTML += '</ul>';
                    }
                    if (details.reasoning.concerns && details.reasoning.concerns.length > 0) {
                        reasoningHTML += '<h4 class="score-reasoning-concerns">‚ö† Concerns</h4><ul class="score-reasoning-concerns">';
                        details.reasoning.concerns.forEach(concern => {
                            reasoningHTML += `<li>${concern}</li>`;
                        });
                        reasoningHTML += '</ul>';
                    }
                    if (details.reasoning.summary) {
                        reasoningHTML += `<div class="score-reasoning-summary">${details.reasoning.summary}</div>`;
                    }
                }
                scoreReasoning.innerHTML = reasoningHTML;
                scoreDetailsSection.style.display = 'block';
            } catch (e) {
                console.error('Error parsing score details:', e);
                scoreDetailsSection.style.display = 'none';
            }
        } else {
            scoreDetailsSection.style.display = 'none';
        }

        const modalButton = document.getElementById('modal-shortlist-button');
        const modalText = document.getElementById('modal-shortlist-text');
        const modalContent = modal.querySelector('.modal-content');

        // Check if this is an archived job
        const isArchived = !job.search_criteria_id && job.shortlisted;

        if (isArchived) {
            modalText.textContent = 'üóë Delete Job';
            modalButton.classList.remove('btn');
            modalButton.classList.add('btn-danger');
            modalButton.dataset.action = 'delete';
            modalContent.classList.add('shortlisted-border');
        } else if (job.shortlisted) {
            modalText.textContent = '‚ô• Shortlisted';
            modalButton.classList.remove('btn');
            modalButton.classList.add('btn-danger');
            modalButton.dataset.action = 'shortlist';
            modalContent.classList.add('shortlisted-border');
        } else {
            modalText.textContent = '‚ô° Shortlist This Job';
            modalButton.classList.remove('btn-danger');
            modalButton.classList.add('btn');
            modalButton.dataset.action = 'shortlist';
            modalContent.classList.remove('shortlisted-border');
        }

        // Update navigation buttons
        document.getElementById('prev-job-button').disabled = currentJobIndex <= 0;
        document.getElementById('next-job-button').disabled = currentJobIndex >= currentVisibleJobs.length - 1;

        // Update position indicator
        document.getElementById('modal-job-position').textContent = `Job ${currentJobIndex + 1} of ${currentVisibleJobs.length}`;

        // Scroll modal to top
        const modalBody = modal.querySelector('.modal-body-wrapper');
        if (modalBody) {
            modalBody.scrollTop = 0;
        }

        modal.style.display = 'block';
    }

    // Navigation button handlers
    document.getElementById('prev-job-button').addEventListener('click', () => navigateJob(-1));
    document.getElementById('next-job-button').addEventListener('click', () => navigateJob(1));

    // Modal shortlist button
    document.getElementById('modal-shortlist-button').addEventListener('click', function() {
        if (currentJobId) {
            const action = this.dataset.action;
            if (action === 'delete') {
                if (confirm('Are you sure you want to delete this job?')) {
                    deleteJob(currentJobId);
                }
            } else {
                toggleShortlist(currentJobId);
            }
        }
    });

    // Close modal
    modal.querySelector('.close-button').addEventListener('click', () => modal.style.display = 'none');
    document.getElementById('close-modal-button').addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', (e) => {
        if (e.target === modal) modal.style.display = 'none';
    });

    // Load first scrape on page load
    {% if scrapes %}
    const firstScrape = document.querySelector('.scrape-chip');
    if (firstScrape) {
        loadScrapeJobs({{ scrapes[0].id }});
    }
    {% endif %}
});
</script>
{% endblock %}
