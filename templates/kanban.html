{% extends "base_fullwidth.html" %}

{% block title %}Kanban Board - {{ super() }}{% endblock %}

{% block head %}
<style>
    .kanban-container {
        padding: 2rem;
        display: flex;
        flex-direction: column;
        height: 100%;
        box-sizing: border-box;
    }

    .kanban-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .kanban-header h1 {
        margin: 0;
    }

    .kanban-board {
        display: flex;
        gap: 1.5rem;
        flex-grow: 1;
        overflow-x: auto;
        padding-bottom: 1rem;
    }

    .kanban-column {
        flex: 1;
        min-width: 320px;
        max-width: 400px;
        background-color: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
    }

    .kanban-column-header {
        padding: 1.25rem 1.5rem;
        border-bottom: 2px solid var(--border-color);
        flex-shrink: 0;
        background-color: var(--card-background);
        border-radius: 12px 12px 0 0;
    }

    .kanban-column-header h2 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .job-count {
        background-color: var(--primary-light);
        color: var(--primary-color);
        padding: 0.25rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .kanban-cards {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
        overflow-y: auto;
        flex-grow: 1;
        min-height: 200px;
    }

    .kanban-card {
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 1.25rem;
        cursor: grab;
        transition: all 0.2s;
        box-shadow: var(--shadow-sm);
    }

    .kanban-card:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary-color);
        transform: translateY(-2px);
    }

    .kanban-card:active {
        cursor: grabbing;
    }

    .kanban-card.dragging {
        opacity: 0.5;
        transform: rotate(2deg);
    }

    .kanban-card h3 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-color);
        line-height: 1.3;
    }

    .kanban-card p {
        margin: 0;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    /* Modal Styling */
    #job-details-modal .modal-content {
        width: 80%;
        max-width: none;
        height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 4px solid var(--border-color);
        transition: border-color 0.3s ease;
    }

    #job-details-modal .modal-body-wrapper {
        overflow-y: auto;
        flex: 1;
        padding: 0 1.5rem;
    }

    .modal-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0 1.5rem 0.35rem 1.5rem;
        margin-top: 0 !important;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        flex-shrink: 0;
    }

    .modal-header-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        margin-bottom: 0 !important;
    }

    .modal-header-content * {
        margin-bottom: 0 !important;
    }

    .modal-header h2 {
        margin: 0 !important;
        font-size: 1.5rem;
        line-height: 1.3;
    }

    #job-details-modal .modal-header {
        padding-bottom: 0 !important;
        margin-bottom: 0 !important;
    }

    .modal-subheader {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        font-size: 0.95rem;
        color: var(--text-secondary);
    }

    .modal-subheader-item {
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .modal-subheader-divider {
        color: var(--border-color);
    }

    .modal-actions {
        padding: 1rem 1.5rem 0 1.5rem;
        margin-bottom: 0 !important;
        flex-shrink: 0;
    }

    .modal-section {
        margin-bottom: 1.25rem;
    }

    .modal-section h3 {
        font-size: 1rem;
        font-weight: 600;
        margin: 0 0 0.75rem 0;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-inline {
        background: none;
        border: 1px solid var(--border-color);
        color: var(--primary-color);
        padding: 0.15rem 0.5rem;
        font-size: 0.85rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-inline:hover {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .job-description-box {
        background-color: var(--background-color);
        padding: 1.5rem;
        border-radius: 8px;
        font-size: 0.9rem;
        line-height: 1.7;
        color: var(--text-color);
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .info-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .info-label {
        font-weight: 600;
        color: var(--text-secondary);
        min-width: 120px;
        font-size: 0.875rem;
    }

    .info-value {
        flex: 1;
        font-size: 0.9rem;
    }

    .info-value input {
        width: 100%;
    }

    .contact-list, .date-list {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .contact-item, .date-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
        padding: 0.35rem 0.5rem;
        background-color: var(--background-color);
        border-radius: 4px;
        font-size: 0.8rem;
    }

    .contact-item-content, .date-item-content {
        flex: 1;
        min-width: 0;
        color: var(--text-color);
    }

    .contact-item-content strong, .date-item-content strong {
        font-weight: 600;
        margin-right: 0.35rem;
    }

    .contact-item-content span, .date-item-content span {
        color: var(--text-secondary);
    }

    .item-actions {
        flex-shrink: 0;
    }

    .delete-contact, .delete-date {
        padding: 0.1rem 0.35rem !important;
        font-size: 0.75rem !important;
        line-height: 1;
        min-width: auto !important;
        background-color: transparent !important;
        border: 1px solid var(--border-color) !important;
        color: var(--text-secondary) !important;
        border-radius: 3px;
    }

    .delete-contact:hover, .delete-date:hover {
        background-color: #ef4444 !important;
        border-color: #ef4444 !important;
        color: white !important;
    }

    .add-item-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        padding: 1rem;
        background-color: var(--background-color);
        border-radius: 8px;
        border: 1px solid var(--border-color);
        margin-top: 0.75rem;
    }

    .add-item-form.full-width {
        grid-template-columns: 1fr;
    }

    .add-item-form input,
    .add-item-form select,
    .add-item-form textarea {
        width: 100%;
    }

    .add-item-form .full-width-field {
        grid-column: 1 / -1;
    }

    #job-details-modal .modal-actions {
        display: flex;
        gap: 0.75rem;
        border-top: 1px solid var(--border-color);
    }

    .modal-actions button, .modal-actions a {
        flex: 1;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        margin-bottom: 0 !important;
    }

    .status-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-new { background-color: #dbeafe; color: #1e40af; }
    .status-interested { background-color: #fef3c7; color: #92400e; }
    .status-applied { background-color: #ddd6fe; color: #5b21b6; }
    .status-interviewing { background-color: #d1fae5; color: #065f46; }
    .status-offer { background-color: #bbf7d0; color: #14532d; }
    .status-rejected { background-color: #f3f4f6; color: #4b5563; }

    .empty-column {
        text-align: center;
        padding: 2rem 1rem;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    textarea {
        min-height: 100px;
        resize: vertical;
    }

    #modal-job-notes {
        min-height: 80px;
        max-height: 300px;
        overflow-y: auto;
        resize: vertical;
    }

    .nav-job-button {
        background: none;
        border: 2px solid var(--border-color);
        color: var(--text-color);
        font-size: 2rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        padding: 0;
        line-height: 1;
    }

    .nav-job-button:hover:not(:disabled) {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        transform: scale(1.1);
    }

    .nav-job-button:disabled {
        opacity: 0.3;
        cursor: not-allowed;
    }

    .modal-nav-bar {
        padding: 0.5rem 1.5rem;
        margin: 1.2rem 0;
        background-color: var(--background-color);
        border-bottom: 1px solid var(--border-color);
        font-size: 0.75rem;
        color: var(--text-secondary);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .modal-nav-shortcuts {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
    }

    .modal-nav-shortcut {
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .modal-nav-key {
        background-color: white;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 0.15rem 0.4rem;
        font-family: monospace;
        font-size: 0.75rem;
        font-weight: 600;
    }

    /* New job highlight animation */
    @keyframes pulseHighlight {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7);
        }
        50% {
            transform: scale(1.05);
            box-shadow: 0 0 0 10px rgba(79, 70, 229, 0);
        }
        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(79, 70, 229, 0);
        }
    }

    .kanban-card.new-job-highlight {
        animation: pulseHighlight 1s ease-out 3;
        border-color: var(--primary-color);
        background-color: var(--primary-light);
    }
</style>
{% endblock %}

{% block content %}
<div class="kanban-container">
    <div class="kanban-header">
        <h1>Job Application Pipeline</h1>
        <button id="add-job-button">+ Add Job</button>
    </div>

    <div class="kanban-board">
        {% for status in statuses %}
        <div class="kanban-column" data-status="{{ status }}">
            <div class="kanban-column-header">
                <h2>
                    {{ status }}
                    <span class="job-count">{{ jobs | selectattr('status', 'equalto', status) | list | length }}</span>
                </h2>
            </div>
            <div class="kanban-cards">
                {% set column_jobs = jobs | selectattr('status', 'equalto', status) | list %}
                {% if column_jobs %}
                    {% for job in column_jobs %}
                    <div class="kanban-card" draggable="true" data-job-id="{{ job.id }}">
                        <h3>{{ job.title }}</h3>
                        <p style="font-weight: 600;">{{ job.company }}</p>
                        {% if job.location %}
                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">üìç {{ job.location }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-column">No jobs in this stage</div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Job Details Modal -->
<div id="job-details-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <button id="prev-job-button" class="nav-job-button" type="button">‚Äπ</button>
            <div class="modal-header-content">
                <h2 id="modal-job-title"></h2>
                <div class="modal-subheader">
                    <span class="modal-subheader-item">
                        <strong id="modal-job-company"></strong>
                    </span>
                    <span class="modal-subheader-divider">‚Ä¢</span>
                    <span class="modal-subheader-item" id="modal-job-location"></span>
                    <span class="modal-subheader-divider">‚Ä¢</span>
                    <span class="modal-subheader-item" id="modal-job-status"></span>
                </div>
                <div class="modal-subheader" style="font-size: 0.85rem; margin-top: 0.15rem; margin-bottom: 0;">
                    <span class="modal-subheader-item">
                        Scraped: <span id="modal-job-scraped"></span>
                    </span>
                    <span class="modal-subheader-divider">‚Ä¢</span>
                    <span class="modal-subheader-item">
                        Last updated: <span id="modal-job-updated"></span>
                    </span>
                </div>
            </div>
            <button id="next-job-button" class="nav-job-button" type="button">‚Ä∫</button>
            <button class="close-button" type="button">&times;</button>
        </div>

        <div class="modal-nav-bar">
            <div class="modal-nav-shortcuts">
                <div class="modal-nav-shortcut">
                    <span class="modal-nav-key">‚Üê</span>
                    <span class="modal-nav-key">‚Üí</span>
                    <span>Navigate jobs</span>
                </div>
                <div class="modal-nav-shortcut">
                    <span class="modal-nav-key">‚Üë</span>
                    <span class="modal-nav-key">‚Üì</span>
                    <span>Scroll</span>
                </div>
                <div class="modal-nav-shortcut">
                    <span class="modal-nav-key">Space</span>
                    <span>Apply</span>
                </div>
                <div class="modal-nav-shortcut">
                    <span class="modal-nav-key">Del</span>
                    <span>Delete</span>
                </div>
                <div class="modal-nav-shortcut">
                    <span class="modal-nav-key">Esc</span>
                    <span>Close</span>
                </div>
            </div>
            <div>
                <span id="modal-job-position">Job 1 of 10</span>
            </div>
        </div>

        <div class="modal-body-wrapper">
            <div class="modal-section">
                <h3>Job Description</h3>
                <div class="job-description-box" id="modal-job-description"></div>
            </div>

        <div class="modal-section">
            <h3>Notes <span id="notes-save-status" style="font-size: 0.75rem; color: #10b981; font-weight: normal;"></span></h3>
            <textarea id="modal-job-notes" placeholder="Add notes about this job..."></textarea>
        </div>

        <div class="modal-section">
            <h3>Contacts <button type="button" id="show-contact-form-button" class="btn-inline">+</button></h3>
            <div id="contact-list" class="contact-list"></div>
            <div class="add-item-form" id="contact-form" style="display: none;">
                <input type="text" id="new-contact-name" placeholder="Name">
                <input type="text" id="new-contact-value" placeholder="Email, Phone, or LinkedIn URL" class="full-width-field">
                <button type="button" id="add-contact-button" class="full-width-field">Add</button>
            </div>
        </div>

        <div class="modal-section">
            <h3>Dates <button type="button" id="show-date-form-button" class="btn-inline">+</button></h3>
            <div id="dates-list" class="date-list"></div>
            <div class="add-item-form full-width" id="date-form" style="display: none;">
                <select id="new-date-category" style="grid-column: 1;">
                    <option value="deadline">Deadline</option>
                    <option value="interview">Interview</option>
                    <option value="followup">Follow-up</option>
                    <option value="other">Other</option>
                </select>
                <input type="datetime-local" id="new-date-input" style="grid-column: 2;">
                <button type="button" id="add-date-button" class="full-width-field">Add</button>
            </div>
        </div>
        </div>

        <div class="modal-actions">
            <button type="button" class="btn-secondary" id="close-modal-button">Close</button>
            <button type="button" class="btn-danger" id="delete-job-button">Delete Job</button>
            <a href="#" id="modal-apply-button" class="btn" target="_blank">Apply Now ‚Üí</a>
        </div>
    </div>
</div>

<!-- Add Job Modal -->
<div id="add-job-modal" class="modal">
    <div class="modal-content" style="max-height: 90vh; overflow: hidden; border-radius: 12px; display: flex; flex-direction: column;">
        <div class="modal-header" style="flex-shrink: 0; padding: 2rem 2rem 1rem 2rem; margin-bottom: 0;">
            <h2>Add New Job</h2>
            <button class="close-button" type="button">&times;</button>
        </div>
        <div style="overflow-y: auto; flex: 1; padding: 0 2rem 2rem 2rem;">
        <form id="add-job-form" style="padding: 0;">
            <div class="form-group">
                <label for="new-job-title">Job Title *</label>
                <input type="text" id="new-job-title" placeholder="e.g., Senior Software Engineer" required>
            </div>
            <div class="form-group">
                <label for="new-job-company">Company *</label>
                <input type="text" id="new-job-company" placeholder="e.g., Tech Corp" required>
            </div>
            <div class="form-group">
                <label for="new-job-location">Location</label>
                <input type="text" id="new-job-location" placeholder="e.g., San Francisco, CA">
            </div>
            <div class="form-group">
                <label for="new-job-description">Job Description</label>
                <textarea id="new-job-description" placeholder="Paste the job description here..." style="min-height: 150px;"></textarea>
            </div>
            <div class="form-group">
                <label for="new-job-link">Application Link</label>
                <input type="url" id="new-job-link" placeholder="https://...">
            </div>
            <div class="form-group">
                <label for="new-job-notes">Notes</label>
                <textarea id="new-job-notes" placeholder="Any initial notes about this job..." style="min-height: 80px;"></textarea>
            </div>
            <div class="modal-actions" style="margin-top: 1rem; padding-top: 1rem;">
                <button type="button" class="btn-secondary" onclick="document.getElementById('add-job-modal').style.display='none'">Cancel</button>
                <button type="submit">Create Job</button>
            </div>
        </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    let currentJobId = null;
    let editingDateId = null;
    let allJobs = [];
    let currentJobIndex = -1;
    let notesAutoSaveTimeout = null;

    const detailsModal = document.getElementById('job-details-modal');
    const addJobModal = document.getElementById('add-job-modal');
    const addJobButton = document.getElementById('add-job-button');
    const addJobForm = document.getElementById('add-job-form');

    // Add Job Modal
    addJobButton.addEventListener('click', () => {
        addJobModal.style.display = 'block';
    });

    addJobForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const title = document.getElementById('new-job-title').value;
        const company = document.getElementById('new-job-company').value;
        const location = document.getElementById('new-job-location').value;
        const description = document.getElementById('new-job-description').value;
        const application_link = document.getElementById('new-job-link').value;
        const notes = document.getElementById('new-job-notes').value;

        fetch('/job', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title,
                company,
                location,
                description,
                application_link,
                notes,
                status: 'Interested',
                shortlisted: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                // Store the new job ID in localStorage to highlight after reload
                localStorage.setItem('newJobId', data.id);
                window.location.reload(); // Reload to show new job
            } else if (data.status === 'error') {
                alert('Error creating job: ' + data.message);
            } else {
                alert('Error creating job');
            }
        })
        .catch(error => {
            alert('Error creating job: ' + error);
        });
    });

    // Collect all jobs on page load
    allJobs = Array.from(document.querySelectorAll('.kanban-card')).map(card => parseInt(card.dataset.jobId));

    // Check for newly created job and apply highlight animation
    const newJobId = localStorage.getItem('newJobId');
    if (newJobId) {
        const newJobCard = document.querySelector(`.kanban-card[data-job-id="${newJobId}"]`);
        if (newJobCard) {
            newJobCard.classList.add('new-job-highlight');
            // Scroll the card into view
            newJobCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Remove the animation class after it completes and remove from localStorage
            setTimeout(() => {
                newJobCard.classList.remove('new-job-highlight');
                localStorage.removeItem('newJobId');
            }, 3000);
        } else {
            localStorage.removeItem('newJobId');
        }
    }

    // Check if job ID is in URL query parameters and auto-open
    const urlParams = new URLSearchParams(window.location.search);
    const jobIdFromUrl = urlParams.get('job');
    if (jobIdFromUrl) {
        const jobId = parseInt(jobIdFromUrl);
        if (allJobs.includes(jobId)) {
            currentJobId = jobId;
            currentJobIndex = allJobs.indexOf(jobId);
            loadJobDetails(jobId);
            // Remove the query parameter from URL without reloading
            window.history.replaceState({}, document.title, '/kanban');
        }
    }

    // Kanban Card Event Listeners
    function addCardEventListeners(card) {
        card.addEventListener('dblclick', () => {
            const jobId = card.dataset.jobId;
            currentJobId = jobId;
            currentJobIndex = allJobs.indexOf(parseInt(jobId));
            loadJobDetails(jobId);
        });

        card.addEventListener('dragstart', () => {
            card.classList.add('dragging');
        });

        card.addEventListener('dragend', () => {
            card.classList.remove('dragging');
        });
    }

    // Load Job Details
    function loadJobDetails(jobId) {
        // Set the current job ID
        currentJobId = jobId;

        fetch(`/job/${jobId}/details`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('modal-job-title').textContent = data.title;
                document.getElementById('modal-job-company').textContent = data.company || 'N/A';
                document.getElementById('modal-job-location').textContent = data.location || 'N/A';
                document.getElementById('modal-job-status').innerHTML = `<span class="status-badge status-${data.status.toLowerCase().replace(' ', '-')}">${data.status}</span>`;
                document.getElementById('modal-apply-button').href = data.application_link;
                document.getElementById('modal-job-description').textContent = data.description || 'No description available';
                document.getElementById('modal-job-notes').value = data.notes || '';

                // Auto-resize notes textarea after loading content
                autoResizeTextarea(document.getElementById('modal-job-notes'));

                // Format and display timestamps
                const scrapedDate = new Date(data.scraped_at);
                const updatedDate = new Date(data.updated_at);
                document.getElementById('modal-job-scraped').textContent = scrapedDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'});
                document.getElementById('modal-job-updated').textContent = updatedDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'});

                // Render contacts
                const contactList = document.getElementById('contact-list');
                contactList.innerHTML = '';
                if (data.contacts && data.contacts.length > 0) {
                    data.contacts.forEach(contact => {
                        const item = document.createElement('div');
                        item.className = 'contact-item';
                        item.innerHTML = `
                            <div class="contact-item-content">
                                <strong>${contact.name}:</strong> <span>${contact.value}</span>
                            </div>
                            <button class="delete-contact" data-contact-id="${contact.id}">√ó</button>
                        `;
                        contactList.appendChild(item);
                    });
                } else {
                    contactList.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.8rem; margin: 0;">No contacts</p>';
                }

                // Render dates
                const datesList = document.getElementById('dates-list');
                datesList.innerHTML = '';
                if (data.dates && data.dates.length > 0) {
                    data.dates.forEach(date => {
                        const item = document.createElement('div');
                        item.className = 'date-item';
                        const dateObj = new Date(date.date);
                        item.innerHTML = `
                            <div class="date-item-content">
                                <strong>${date.category}:</strong> <span>${dateObj.toLocaleString('en-US', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'})}</span>
                            </div>
                            <button class="delete-date" data-date-id="${date.id}">√ó</button>
                        `;
                        datesList.appendChild(item);
                    });
                } else {
                    datesList.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.8rem; margin: 0;">No dates</p>';
                }

                // Update navigation buttons
                document.getElementById('prev-job-button').disabled = currentJobIndex <= 0;
                document.getElementById('next-job-button').disabled = currentJobIndex >= allJobs.length - 1;

                // Update position indicator
                document.getElementById('modal-job-position').textContent = `Job ${currentJobIndex + 1} of ${allJobs.length}`;

                // Scroll modal to top
                const modalBody = document.querySelector('.modal-body-wrapper');
                if (modalBody) {
                    modalBody.scrollTop = 0;
                }

                detailsModal.style.display = 'block';
            });
    }

    // Function to auto-resize textarea
    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        const newHeight = Math.min(textarea.scrollHeight, 300);
        textarea.style.height = newHeight + 'px';
    }

    // Auto-save notes with debouncing and auto-resize
    const notesTextarea = document.getElementById('modal-job-notes');
    const saveStatus = document.getElementById('notes-save-status');

    console.log('Notes textarea found:', notesTextarea);

    notesTextarea.addEventListener('input', () => {
        console.log('Input event fired!');

        // Auto-resize the textarea
        autoResizeTextarea(notesTextarea);

        // Show "saving..." indicator
        saveStatus.textContent = 'saving...';
        saveStatus.style.color = '#f59e0b';

        if (notesAutoSaveTimeout) {
            clearTimeout(notesAutoSaveTimeout);
        }

        notesAutoSaveTimeout = setTimeout(() => {
            // Only save if we have a current job ID
            if (!currentJobId) {
                console.warn('No job ID set, skipping auto-save');
                saveStatus.textContent = 'no job selected';
                saveStatus.style.color = '#ef4444';
                return;
            }

            const notes = notesTextarea.value;

            console.log('Auto-saving notes for job:', currentJobId, 'Notes length:', notes.length);

            fetch(`/job/${currentJobId}/details`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: notes })
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('Save result:', result);
                if (result.status === 'success') {
                    // Show success indicator
                    saveStatus.textContent = '‚úì saved';
                    saveStatus.style.color = '#10b981';
                    setTimeout(() => {
                        saveStatus.textContent = '';
                    }, 2000);
                } else {
                    console.error('Error saving notes:', result.message);
                    saveStatus.textContent = 'error saving';
                    saveStatus.style.color = '#ef4444';
                }
            })
            .catch(error => {
                console.error('Error auto-saving notes:', error);
                saveStatus.textContent = 'error: ' + error.message;
                saveStatus.style.color = '#ef4444';
            });
        }, 1000); // Auto-save 1 second after user stops typing
    });

    // Delete Job
    document.getElementById('delete-job-button').addEventListener('click', () => {
        if (confirm('Are you sure you want to delete this job?')) {
            fetch(`/job/${currentJobId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        location.reload();
                    } else {
                        alert('Error deleting job');
                    }
                });
        }
    });

    // Toggle contact form
    document.getElementById('show-contact-form-button').addEventListener('click', () => {
        const form = document.getElementById('contact-form');
        if (form.style.display === 'none' || form.style.display === '') {
            form.style.display = 'grid';
        } else {
            form.style.display = 'none';
        }
    });

    // Add Contact
    document.getElementById('add-contact-button').addEventListener('click', () => {
        const name = document.getElementById('new-contact-name').value;
        const value = document.getElementById('new-contact-value').value;

        if (!name || !value) {
            alert('Please fill in name and contact value');
            return;
        }

        // Auto-detect type based on value
        let type = 'other';
        if (value.includes('@')) {
            type = 'email';
        } else if (value.includes('linkedin.com')) {
            type = 'linkedin';
        } else if (/^\+?[\d\s\-()]+$/.test(value)) {
            type = 'phone';
        }

        fetch(`/job/${currentJobId}/contact`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, type, value })
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                document.getElementById('new-contact-name').value = '';
                document.getElementById('new-contact-value').value = '';
                document.getElementById('contact-form').style.display = 'none';
                loadJobDetails(currentJobId);
            } else {
                alert('Error adding contact');
            }
        });
    });

    // Delete Contact
    document.getElementById('contact-list').addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-contact')) {
            const contactId = e.target.dataset.contactId;
            fetch(`/contact/${contactId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        loadJobDetails(currentJobId);
                    } else {
                        alert('Error deleting contact');
                    }
                });
        }
    });

    // Toggle date form
    document.getElementById('show-date-form-button').addEventListener('click', () => {
        const form = document.getElementById('date-form');
        if (form.style.display === 'none' || form.style.display === '') {
            form.style.display = 'grid';
        } else {
            form.style.display = 'none';
        }
    });

    // Add Date
    document.getElementById('add-date-button').addEventListener('click', () => {
        const category = document.getElementById('new-date-category').value;
        const date = document.getElementById('new-date-input').value;

        if (!date) {
            alert('Please select a date');
            return;
        }

        fetch(`/job/${currentJobId}/date`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                date,
                category,
                title: category,
                description: ''
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                document.getElementById('new-date-input').value = '';
                document.getElementById('date-form').style.display = 'none';
                loadJobDetails(currentJobId);
            } else {
                alert('Error adding date');
            }
        });
    });

    // Delete Date
    document.getElementById('dates-list').addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-date')) {
            const dateId = e.target.dataset.dateId;
            fetch(`/job_date/${dateId}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(result => {
                    if (result.status === 'success') {
                        loadJobDetails(currentJobId);
                    } else {
                        alert('Error deleting date');
                    }
                });
        }
    });

    // Navigate to previous/next job
    function navigateJob(direction) {
        if (allJobs.length === 0) return;

        currentJobIndex += direction;
        if (currentJobIndex < 0) currentJobIndex = 0;
        if (currentJobIndex >= allJobs.length) currentJobIndex = allJobs.length - 1;

        currentJobId = allJobs[currentJobIndex];
        loadJobDetails(currentJobId);
    }

    // Navigation button handlers
    document.getElementById('prev-job-button').addEventListener('click', () => navigateJob(-1));
    document.getElementById('next-job-button').addEventListener('click', () => navigateJob(1));

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        // Only handle keyboard shortcuts when modal is open
        if (detailsModal.style.display !== 'block') return;

        // Don't interfere with typing in inputs, textareas, or selects
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                if (currentJobIndex > 0) {
                    navigateJob(-1);
                }
                break;
            case 'ArrowRight':
                e.preventDefault();
                if (currentJobIndex < allJobs.length - 1) {
                    navigateJob(1);
                }
                break;
            case 'ArrowUp':
                e.preventDefault();
                // Scroll up in modal
                const modalBody = document.querySelector('.modal-body-wrapper');
                modalBody.scrollBy({ top: -100, behavior: 'smooth' });
                break;
            case 'ArrowDown':
                e.preventDefault();
                // Scroll down in modal
                const modalBodyDown = document.querySelector('.modal-body-wrapper');
                modalBodyDown.scrollBy({ top: 100, behavior: 'smooth' });
                break;
            case ' ':
                e.preventDefault();
                // Click the apply button
                document.getElementById('modal-apply-button').click();
                break;
            case 'Delete':
                e.preventDefault();
                // Delete job
                document.getElementById('delete-job-button').click();
                break;
            case 'Escape':
                e.preventDefault();
                detailsModal.style.display = 'none';
                break;
        }
    });

    // Close Modals
    document.querySelectorAll('.close-button').forEach(btn => {
        btn.addEventListener('click', () => {
            detailsModal.style.display = 'none';
            addJobModal.style.display = 'none';
        });
    });

    document.getElementById('close-modal-button').addEventListener('click', () => {
        detailsModal.style.display = 'none';
    });

    window.addEventListener('click', (e) => {
        if (e.target === detailsModal) detailsModal.style.display = 'none';
        if (e.target === addJobModal) addJobModal.style.display = 'none';
    });

    // Drag and Drop
    document.querySelectorAll('.kanban-card').forEach(addCardEventListeners);

    document.querySelectorAll('.kanban-column').forEach(column => {
        column.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(column, e.clientY);
            const dragging = document.querySelector('.dragging');
            const cardsContainer = column.querySelector('.kanban-cards');

            if (afterElement == null) {
                cardsContainer.appendChild(dragging);
            } else {
                cardsContainer.insertBefore(dragging, afterElement);
            }
        });

        column.addEventListener('drop', e => {
            e.preventDefault();
            const dragging = document.querySelector('.dragging');
            const newStatus = column.dataset.status;
            const jobId = dragging.dataset.jobId;

            fetch(`/job/${jobId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update job counts
                    location.reload();
                } else {
                    console.error('Failed to update job status');
                }
            });
        });
    });

    function getDragAfterElement(column, y) {
        const draggableElements = [...column.querySelectorAll('.kanban-card:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
});
</script>
{% endblock %}
