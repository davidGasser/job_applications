{% extends "base.html" %}

{% block title %}Scrape Jobs - {{ super() }}{% endblock %}

{% block head %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .scraper-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .scraper-card {
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s;
    }

    .scraper-card:hover {
        box-shadow: var(--shadow-md);
        border-color: var(--primary-color);
    }

    .scraper-card h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .scraper-card p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .scraper-card .actions {
        display: flex;
        gap: 0.75rem;
        margin-top: auto;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .scraper-card .actions button {
        flex: 1;
        padding: 0.5rem;
        font-size: 0.875rem;
    }

    .scraper-card .btn-run {
        background-color: var(--success-color);
    }

    .scraper-card .btn-run:hover {
        background-color: #059669;
    }

    .scraper-card .btn-run.running {
        background-color: #f59e0b;
        cursor: not-allowed;
    }

    .scraper-card .btn-run.running:hover {
        background-color: #f59e0b;
        transform: none;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .spinner {
        display: inline-block;
        animation: spin 1s linear infinite;
    }

    .log-section {
        margin-top: 3rem;
        background-color: var(--card-background);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: var(--shadow-sm);
    }

    .log-section h2 {
        margin-top: 0;
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .log-container {
        background-color: #f3f4f6;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        white-space: pre-wrap;
        word-wrap: break-word;
        color: var(--text-color);
    }

    .status-message {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        background-color: var(--primary-light);
        color: var(--primary-color);
        font-weight: 500;
    }

    .status-message a {
        color: var(--primary-color);
        text-decoration: underline;
    }

    /* Button Group for Toggle Buttons */
    .toggle-button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .toggle-button {
        background-color: white;
        border: 2px solid var(--border-color);
        color: var(--text-color);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s;
        text-transform: capitalize;
    }

    .toggle-button:hover {
        border-color: var(--primary-color);
        background-color: var(--primary-light);
        transform: translateY(0);
        box-shadow: none;
    }

    .toggle-button.active {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
        box-shadow: var(--shadow-sm);
    }

    .modal-body {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }

    .form-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }

    .form-actions button,
    .form-actions a {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        padding-right: 2.5rem;
    }
</style>
{% endblock %}

{% block content %}
    <div class="page-header">
        <h1>Job Scraper</h1>
        <button id="add-scraper-button">+ Add Scraper Configuration</button>
    </div>

    <div id="scraper-container" class="scraper-container"></div>

    <div class="log-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 style="margin: 0;">Scraper Log</h2>
            <button id="stop-scrape-button" class="btn-danger" style="display: none;">⏹ Stop Scraping</button>
        </div>
        <div class="log-container" id="log">Awaiting scrape to start...</div>
        <div id="status" class="status-message" style="display: none;"></div>
    </div>

    <!-- Warning Modal for Missing Profile -->
    <div id="profile-warning-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>⚠️ Profile Incomplete</h2>
                <button class="close-button" type="button" onclick="document.getElementById('profile-warning-modal').style.display='none'">&times;</button>
            </div>
            <div class="modal-body">
                <p>You haven't completed your profile setup. Without a CV and job preferences, job fit scores cannot be calculated.</p>
                <div id="profile-warning-details" style="margin: 1rem 0; padding: 1rem; background-color: #fef3c7; border-radius: 8px; font-size: 0.9rem;">
                    <p style="margin: 0.5rem 0;"><strong>Missing:</strong></p>
                    <ul id="missing-items" style="margin: 0.5rem 0; padding-left: 1.5rem;"></ul>
                </div>
                <p style="margin-bottom: 0;">Do you want to continue scraping without job fit scoring?</p>
            </div>
            <div class="form-actions">
                <a href="/prompt" class="btn btn-secondary" style="text-decoration: none;">Setup Profile</a>
                <button type="button" class="btn" id="continue-scrape-button">Continue Anyway</button>
            </div>
        </div>
    </div>

    <!-- Modal for Add/Edit Scraper -->
    <div id="scraper-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="scraper-modal-title">Add Scraper Configuration</h2>
                <button class="close-button" type="button">&times;</button>
            </div>
            <form id="scraper-form">
                <input type="hidden" id="scraper-id">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="keywords">Keywords *</label>
                        <input type="text" id="keywords" placeholder="e.g., Software Engineer, Data Scientist" required>
                    </div>

                    <div class="form-group">
                        <label for="locations">Locations (comma-separated) *</label>
                        <input type="text" id="locations" placeholder="e.g., New York, San Francisco, Remote" required>
                    </div>

                    <div class="form-group">
                        <label for="distance">Distance (km)</label>
                        <select id="distance">
                            <option value="">Any Distance</option>
                            {% for km in distance_map %}
                            <option value="{{ km }}">Within {{ km }} km</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="date_posted">Date Posted</label>
                        <select id="date_posted">
                            <option value="">Any Time</option>
                            {% for date in date_map %}
                            <option value="{{ date }}">{{ date | title }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="pages">Number of Pages to Scrape</label>
                        <input type="number" id="pages" min="1" max="10" value="1" placeholder="1">
                    </div>

                    <div class="form-group">
                        <label>Experience Level</label>
                        <div class="toggle-button-group" id="exp-level-group">
                            {% for level in exp_level_map %}
                            <button type="button" class="toggle-button" data-value="{{ level }}">
                                {{ level.replace(' level','') | title }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Job Type</label>
                        <div class="toggle-button-group" id="job-type-group">
                            {% for type in job_type_map %}
                            <button type="button" class="toggle-button" data-value="{{ type }}">
                                {{ type | title }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="form-group" style="border-top: 1px solid var(--border-color); padding-top: 1.25rem; margin-top: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="schedule-enabled" style="width: auto; cursor: pointer;">
                            <span>Enable Automatic Scheduling</span>
                        </label>
                    </div>

                    <div id="schedule-options" style="display: none;">
                        <div class="form-group">
                            <label for="schedule-time">Run Time</label>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" id="schedule-hour" min="0" max="23" placeholder="HH" style="width: 80px; text-align: center;">
                                <span>:</span>
                                <input type="number" id="schedule-minute" min="0" max="59" value="0" placeholder="MM" style="width: 80px; text-align: center;">
                            </div>
                        </div>

                        <div class="form-group" id="schedule-day-of-week-group" style="display: none;">
                            <label for="schedule-day-of-week">Day of Week</label>
                            <select id="schedule-day-of-week">
                                <option value="0">Monday</option>
                                <option value="1">Tuesday</option>
                                <option value="2">Wednesday</option>
                                <option value="3">Thursday</option>
                                <option value="4">Friday</option>
                                <option value="5">Saturday</option>
                                <option value="6">Sunday</option>
                            </select>
                        </div>

                        <div class="form-group" id="schedule-day-of-month-group" style="display: none;">
                            <label for="schedule-day-of-month">Day of Month</label>
                            <input type="number" id="schedule-day-of-month" min="1" max="31" value="1" placeholder="1-31">
                        </div>

                        <div id="schedule-frequency-hint" style="font-size: 0.85rem; color: var(--text-secondary); padding: 0.75rem; background-color: var(--primary-light); border-radius: 8px; margin-top: 0.5rem;"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="document.getElementById('scraper-modal').style.display='none'">Cancel</button>
                    <button type="submit">Save Configuration</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
    const log = document.getElementById('log');
    const status = document.getElementById('status');
    const stopButton = document.getElementById('stop-scrape-button');

    socket.on('connect', () => {
        console.log('[SCRAPER] WebSocket connected!');
    });

    socket.on('disconnect', () => {
        console.log('[SCRAPER] WebSocket disconnected!');
    });

    socket.on('log_message', (msg) => {
        console.log('[SCRAPER] Received log:', msg);
        log.textContent += msg.data + '\n';
        log.scrollTop = log.scrollHeight;
    });

    socket.on('job_processed', (msg) => {
        console.log('[SCRAPER] Job processed:', msg);
        const jobTitle = msg.job;
        const company = msg.company;
        const location = msg.location;
        const score = msg.score;
        log.textContent += `Saved ${jobTitle} @ ${company} in ${location} with score ${score}\n`;
        log.scrollTop = log.scrollHeight;
    });

    socket.on('scrape_finished', (msg) => {
        console.log('[SCRAPER] Scrape finished:', msg);
        log.textContent += '\n✓ ' + msg.data + '\n';
        status.innerHTML = `<a href="/">View Scraped Jobs</a>`;
        status.style.display = 'block';
        log.scrollTop = log.scrollHeight;
        stopButton.style.display = 'none';
        resetAllRunButtons();
    });

    socket.on('scrape_error', (msg) => {
        console.log('[SCRAPER] Scrape error:', msg);
        log.textContent += '\n✗ ERROR: ' + msg.data + '\n';
        log.scrollTop = log.scrollHeight;
        stopButton.style.display = 'none';
        resetAllRunButtons();
    });

    socket.on('scrape_stopped', (msg) => {
        console.log('[SCRAPER] Scrape stopped:', msg);
        log.textContent += '\n⏸ STOPPED: ' + msg.data + '\n';
        status.innerHTML = `Scraping was interrupted. <a href="/">View Scraped Jobs</a>`;
        status.style.display = 'block';
        log.scrollTop = log.scrollHeight;
        stopButton.style.display = 'none';
        resetAllRunButtons();
    });

    function resetAllRunButtons() {
        document.querySelectorAll('.run-scraper').forEach(btn => {
            btn.classList.remove('running');
            btn.disabled = false;
            btn.innerHTML = '▶ Run';
        });
    }

    function setRunButtonLoading(button) {
        button.classList.add('running');
        button.disabled = true;
        button.innerHTML = '<span class="spinner">⟳</span> Running...';
    }

    stopButton.addEventListener('click', () => {
        socket.emit('stop_scrape');
        stopButton.disabled = true;
        stopButton.textContent = '⏹ Stopping...';
    });

    const scraperContainer = document.getElementById('scraper-container');
    const addScraperButton = document.getElementById('add-scraper-button');
    const scraperModal = document.getElementById('scraper-modal');
    const scraperModalTitle = document.getElementById('scraper-modal-title');
    const scraperForm = document.getElementById('scraper-form');
    const scraperIdInput = document.getElementById('scraper-id');
    const closeModalButton = scraperModal.querySelector('.close-button');
    const profileWarningModal = document.getElementById('profile-warning-modal');
    const continueButton = document.getElementById('continue-scrape-button');
    const missingItemsList = document.getElementById('missing-items');

    // Store pending scrape data
    let pendingScrapeId = null;
    let pendingScrapeButton = null;

    // Check profile and show warning if incomplete
    async function checkProfileAndStartScrape(id, button) {
        try {
            const response = await fetch('/profile/check');
            const result = await response.json();

            if (result.is_complete) {
                // Profile is complete, proceed directly
                startScrape(id, button);
            } else {
                // Profile is incomplete, show warning
                pendingScrapeId = id;
                pendingScrapeButton = button;

                // Update missing items list
                missingItemsList.innerHTML = '';
                if (!result.has_cv) {
                    const li = document.createElement('li');
                    li.textContent = 'CV/Resume not uploaded';
                    missingItemsList.appendChild(li);
                }
                if (!result.has_preferences) {
                    const li = document.createElement('li');
                    li.textContent = 'Job preferences not provided';
                    missingItemsList.appendChild(li);
                }

                // Show warning modal
                profileWarningModal.style.display = 'block';
            }
        } catch (error) {
            console.error('Error checking profile:', error);
            // If check fails, proceed anyway
            startScrape(id, button);
        }
    }

    // Actually start the scrape
    function startScrape(id, button) {
        console.log('[SCRAPER] Starting scrape for ID:', id);
        setRunButtonLoading(button);
        log.textContent = 'Starting scrape...\n';
        status.style.display = 'none';
        stopButton.style.display = 'block';
        stopButton.disabled = false;
        stopButton.textContent = '⏹ Stop Scraping';
        fetch(`/search_criteria/${id}`)
            .then(response => response.json())
            .then(data => {
                console.log('[SCRAPER] Emitting start_scrape with data:', data);
                socket.emit('start_scrape', { data: data });
            });
    }

    // Continue button handler
    continueButton.addEventListener('click', () => {
        profileWarningModal.style.display = 'none';
        if (pendingScrapeId && pendingScrapeButton) {
            startScrape(pendingScrapeId, pendingScrapeButton);
            pendingScrapeId = null;
            pendingScrapeButton = null;
        }
    });

    // Toggle button functionality
    function setupToggleButtons() {
        document.querySelectorAll('.toggle-button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                button.classList.toggle('active');
            });
        });
    }

    setupToggleButtons();

    // Scheduling UI logic
    const scheduleEnabledCheckbox = document.getElementById('schedule-enabled');
    const scheduleOptions = document.getElementById('schedule-options');
    const datePostedSelect = document.getElementById('date_posted');
    const scheduleDayOfWeekGroup = document.getElementById('schedule-day-of-week-group');
    const scheduleDayOfMonthGroup = document.getElementById('schedule-day-of-month-group');
    const scheduleFrequencyHint = document.getElementById('schedule-frequency-hint');

    scheduleEnabledCheckbox.addEventListener('change', () => {
        scheduleOptions.style.display = scheduleEnabledCheckbox.checked ? 'block' : 'none';
        updateScheduleFrequencyUI();
    });

    datePostedSelect.addEventListener('change', updateScheduleFrequencyUI);

    function updateScheduleFrequencyUI() {
        if (!scheduleEnabledCheckbox.checked) return;

        const datePosted = datePostedSelect.value;

        // Hide both by default
        scheduleDayOfWeekGroup.style.display = 'none';
        scheduleDayOfMonthGroup.style.display = 'none';

        if (datePosted === 'past 24 hours') {
            scheduleFrequencyHint.textContent = 'This scraper will run daily at the specified time.';
        } else if (datePosted === 'past week') {
            scheduleDayOfWeekGroup.style.display = 'block';
            scheduleFrequencyHint.textContent = 'This scraper will run weekly on the specified day and time.';
        } else if (datePosted === 'past month') {
            scheduleDayOfMonthGroup.style.display = 'block';
            scheduleFrequencyHint.textContent = 'This scraper will run monthly on the specified day and time.';
        } else {
            scheduleFrequencyHint.textContent = 'Select a "Date Posted" filter to configure scheduling frequency.';
        }
    }

    function openModalForCreate() {
        scraperIdInput.value = '';
        scraperModalTitle.textContent = 'Add Scraper Configuration';
        scraperForm.reset();
        // Clear all toggle buttons
        document.querySelectorAll('.toggle-button').forEach(btn => btn.classList.remove('active'));
        // Reset scheduling fields
        scheduleEnabledCheckbox.checked = false;
        scheduleOptions.style.display = 'none';
        scraperModal.style.display = 'block';
    }

    function openModalForEdit(criteria) {
        scraperIdInput.value = criteria.id;
        scraperModalTitle.textContent = 'Edit Scraper Configuration';
        document.getElementById('keywords').value = criteria.keywords;
        document.getElementById('locations').value = criteria.locations;
        document.getElementById('distance').value = criteria.distance_in_km || '';
        document.getElementById('date_posted').value = criteria.date_posted || '';
        document.getElementById('pages').value = criteria.pages || 1;

        // Clear all toggle buttons first
        document.querySelectorAll('.toggle-button').forEach(btn => btn.classList.remove('active'));

        // Set experience level toggles
        if (criteria.exp_level) {
            const expLevels = criteria.exp_level.split(', ');
            document.querySelectorAll('#exp-level-group .toggle-button').forEach(btn => {
                if (expLevels.includes(btn.dataset.value)) {
                    btn.classList.add('active');
                }
            });
        }

        // Set job type toggles
        if (criteria.job_type) {
            const jobTypes = criteria.job_type.split(', ');
            document.querySelectorAll('#job-type-group .toggle-button').forEach(btn => {
                if (jobTypes.includes(btn.dataset.value)) {
                    btn.classList.add('active');
                }
            });
        }

        // Set scheduling fields
        scheduleEnabledCheckbox.checked = criteria.schedule_enabled || false;
        document.getElementById('schedule-hour').value = criteria.schedule_hour || '';
        document.getElementById('schedule-minute').value = criteria.schedule_minute || 0;
        document.getElementById('schedule-day-of-week').value = criteria.schedule_day_of_week || 0;
        document.getElementById('schedule-day-of-month').value = criteria.schedule_day_of_month || 1;

        scheduleOptions.style.display = criteria.schedule_enabled ? 'block' : 'none';
        updateScheduleFrequencyUI();

        scraperModal.style.display = 'block';
    }

    function renderScraperCards(criterias) {
        if (criterias.length === 0) {
            scraperContainer.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">No scraper configurations yet. Click "Add Scraper Configuration" to create one.</p>';
            return;
        }

        scraperContainer.innerHTML = '';
        criterias.forEach(criteria => {
            const card = document.createElement('div');
            card.classList.add('scraper-card');
            card.dataset.id = criteria.id;

            let filters = [];
            if (criteria.distance_in_km) filters.push(`${criteria.distance_in_km}km radius`);
            if (criteria.date_posted) filters.push(criteria.date_posted);
            if (criteria.exp_level) {
                // exp_level is already a comma-separated string, don't split it into characters
                filters.push(criteria.exp_level);
            }
            if (criteria.job_type) {
                // job_type is already a comma-separated string, don't split it into characters
                filters.push(criteria.job_type);
            }

            // Create a proper filter display string
            const filterDisplay = filters.length > 0 ? filters.join(' • ') : '';

            // Generate schedule display
            let scheduleDisplay = '';
            if (criteria.schedule_enabled) {
                const hour = String(criteria.schedule_hour || 0).padStart(2, '0');
                const minute = String(criteria.schedule_minute || 0).padStart(2, '0');
                let scheduleText = '';

                if (criteria.date_posted === 'past 24 hours') {
                    scheduleText = `Daily at ${hour}:${minute}`;
                } else if (criteria.date_posted === 'past week') {
                    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                    const dayName = days[criteria.schedule_day_of_week || 0];
                    scheduleText = `Weekly on ${dayName} at ${hour}:${minute}`;
                } else if (criteria.date_posted === 'past month') {
                    const day = criteria.schedule_day_of_month || 1;
                    scheduleText = `Monthly on day ${day} at ${hour}:${minute}`;
                } else {
                    scheduleText = `Scheduled at ${hour}:${minute}`;
                }

                const lastRun = criteria.last_run ? new Date(criteria.last_run).toLocaleString() : 'Never';
                scheduleDisplay = `
                    <div style="background-color: #ecfdf5; border: 1px solid #10b981; border-radius: 8px; padding: 0.75rem; margin-top: 0.5rem;">
                        <p style="margin: 0; font-size: 0.85rem; color: #047857; font-weight: 600;">⏰ ${scheduleText}</p>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem; color: #059669;">Last run: ${lastRun}</p>
                    </div>
                `;
            }

            card.innerHTML = `
                <h3>${criteria.keywords}</h3>
                <p><strong>Locations:</strong> ${criteria.locations}</p>
                ${filterDisplay ? `<p style="font-size: 0.85rem; color: var(--text-secondary);"><strong>Filters:</strong> ${filterDisplay}</p>` : ''}
                ${scheduleDisplay}
                <div class="actions">
                    <button class="btn-run run-scraper">▶ Run</button>
                    <button class="btn-secondary edit-scraper">Edit</button>
                    <button class="btn-danger delete-scraper">Delete</button>
                </div>
            `;
            scraperContainer.appendChild(card);
        });
    }

    function fetchAndRenderScrapers() {
        fetch('/search_criterias')
            .then(response => response.json())
            .then(renderScraperCards);
    }

    addScraperButton.addEventListener('click', openModalForCreate);
    closeModalButton.addEventListener('click', () => scraperModal.style.display = 'none');

    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target === scraperModal) {
            scraperModal.style.display = 'none';
        }
    });

    scraperForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = scraperIdInput.value;

        // Get selected experience levels
        const expLevels = Array.from(document.querySelectorAll('#exp-level-group .toggle-button.active'))
            .map(btn => btn.dataset.value);

        // Get selected job types
        const jobTypes = Array.from(document.querySelectorAll('#job-type-group .toggle-button.active'))
            .map(btn => btn.dataset.value);

        const data = {
            keywords: document.getElementById('keywords').value,
            locations: document.getElementById('locations').value,
            distance_in_km: document.getElementById('distance').value || null,
            date_posted: document.getElementById('date_posted').value || null,
            pages: parseInt(document.getElementById('pages').value) || 1,
            exp_level: expLevels.length > 0 ? expLevels.join(', ') : null,
            job_type: jobTypes.length > 0 ? jobTypes.join(', ') : null,
            schedule_enabled: scheduleEnabledCheckbox.checked,
            schedule_hour: scheduleEnabledCheckbox.checked ? parseInt(document.getElementById('schedule-hour').value) || null : null,
            schedule_minute: scheduleEnabledCheckbox.checked ? parseInt(document.getElementById('schedule-minute').value) || 0 : null,
            schedule_day_of_week: scheduleEnabledCheckbox.checked ? parseInt(document.getElementById('schedule-day-of-week').value) || null : null,
            schedule_day_of_month: scheduleEnabledCheckbox.checked ? parseInt(document.getElementById('schedule-day-of-month').value) || null : null
        };

        const url = id ? `/search_criteria/${id}` : '/search_criteria';
        const method = id ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success' || result.id) {
                scraperModal.style.display = 'none';
                fetchAndRenderScrapers();
            } else {
                alert('Error saving scraper configuration');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving');
        });
    });

    scraperContainer.addEventListener('click', (e) => {
        const target = e.target;
        const card = target.closest('.scraper-card');
        if (!card) return;

        const id = card.dataset.id;

        if (target.classList.contains('edit-scraper')) {
            fetch(`/search_criteria/${id}`)
                .then(response => response.json())
                .then(openModalForEdit);
        } else if (target.classList.contains('delete-scraper')) {
            if (confirm('Are you sure you want to delete this scraper configuration?')) {
                fetch(`/search_criteria/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(result => {
                        if (result.status === 'success') {
                            fetchAndRenderScrapers();
                        } else {
                            alert('Error deleting scraper configuration');
                        }
                    });
            }
        } else if (target.classList.contains('run-scraper')) {
            // Check profile before starting scrape
            checkProfileAndStartScrape(id, target);
        }
    });

    fetchAndRenderScrapers();
});
</script>
{% endblock %}
